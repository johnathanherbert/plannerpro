rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserHouseholdId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.householdId;
    }
    
    function getHousehold(householdId) {
      return get(/databases/$(database)/documents/households/$(householdId)).data;
    }
    
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    match /households/{householdId} {
      allow read, write: if isAuthenticated();
    }
    
    match /transactions/{transactionId} {
      // Privacy rules for transactions:
      // 1. Can always create transactions in your household
      // 2. Can read if:
      //    - You created it (createdBy)
      //    - It's a household expense (isHouseholdExpense)
      //    - You're in sharedWithUsers array
      //    - Creator and you both enabled showMemberTransactions
      //    - It's in your household (for credit card queries)
      //    - Has creditCardId field (for billing calculations - must be in same household)
      allow create: if isAuthenticated() && 
                      request.resource.data.householdId == getUserHouseholdId() &&
                      request.resource.data.createdBy == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
                               resource.data.createdBy == request.auth.uid;
      
      allow read: if isAuthenticated() && (
        // Own transaction (includes credit card queries with userId filter)
        resource.data.createdBy == request.auth.uid ||
        // Household expense
        resource.data.isHouseholdExpense == true ||
        // Target is household
        resource.data.target == 'household' ||
        // Explicitly shared with you
        (resource.data.sharedWithUsers != null && 
         request.auth.uid in resource.data.sharedWithUsers) ||
        // Transaction belongs to user's household (for queries)
        resource.data.householdId == getUserHouseholdId()
      );
    }
    
    match /invitations/{invitationId} {
      allow read, write: if isAuthenticated();
    }
    
    match /accounts/{accountId} {
      allow read, write: if isAuthenticated();
    }
    
    match /creditCards/{cardId} {
      allow read, write: if isAuthenticated();
    }
    
    match /creditCardBills/{billId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.householdId == getUserHouseholdId()
      );
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.householdId == getUserHouseholdId();
      allow update: if isAuthenticated() && 
                      resource.data.householdId == getUserHouseholdId();
      allow delete: if isAuthenticated() && 
                      resource.data.householdId == getUserHouseholdId();
    }
  }
}